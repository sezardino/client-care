generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRoles {
  ADMIN
  OWNER
  MEMBER
}

model User {
  id        String @id @unique @default(cuid())
  email     String @unique
  firstName String @default("") @map("first_name")
  lastName  String @default("") @map("last_name")
  position  String @default("")

  inviteId String? @default(cuid()) @map("invite_id")

  role UserRoles @default(OWNER)

  avatar   File?   @relation(fields: [avatarId], references: [id])
  avatarId String? @map("avatar_id")

  organization   Organization? @relation(fields: [organizationId], references: [id], name: "organization-members")
  organizationId String?       @map("organization_id")

  owner Organization? @relation("organization-owner")

  updatedAt DateTime  @updatedAt @map("updated_at")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("users")
}

model File {
  id         String @id @default(uuid())
  path       String
  fullPath   String @map("full_path")
  publicPath String @map("public_path")

  avatar  User[]
  logo    Organization[]
  project Project[]

  createdAt          DateTime @default(now()) @map("created_at")
  Report             Report?  @relation(fields: [reportSubmissionId], references: [submissionId])
  reportSubmissionId String?

  @@map("files")
}

model Organization {
  id   String @id @unique @default(cuid())
  slug String @unique

  name  String
  extra String @default("")

  members User[] @relation("organization-members")
  ownerId String @unique @map("owner_id")
  owner   User   @relation("organization-owner", fields: [ownerId], references: [id])

  projects    Project[]
  widgets     Widget[]
  submissions Submission[]

  logo   File?   @relation(fields: [logoId], references: [id])
  logoId String? @map("logo_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("organizations")
}

model Project {
  id   String @id @unique @default(cuid())
  slug String
  name String
  url  String @default("")

  description String @default("")

  widgets     Widget[]
  submissions Submission[]

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])

  logo   File?   @relation(fields: [logoId], references: [id])
  logoId String? @map("logo_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("projects")
}

enum WidgetType {
  FEEDBACK
  REPORT
  CONTACT
  SURVEY
}

model Widget {
  id   String     @id @default(cuid())
  name String
  type WidgetType

  isActive Boolean @default(false) @map("is_active")
  isTest   Boolean @default(false) @map("is_test")

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])

  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id])

  submissions Submission[]

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("widgets")
}

model Submission {
  id String @id @default(cuid())

  email    String
  fullName String @default("") @map("full_name")
  phone    String @default("")

  widget   Widget @relation(fields: [widgetId], references: [id])
  widgetId String

  feedback Feedback? @relation("submission-feedback")
  report   Report?   @relation("submission-report")
  contact  Contact?  @relation("submission-contact")
  survey   Survey?   @relation("submission-survey")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project   Project @relation(fields: [projectId], references: [id])
  projectId String  @map("project_id")

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("submissions")
}

// widgets

model Feedback {
  submissionId String     @id @default(cuid()) @map("submission_id")
  submission   Submission @relation("submission-feedback", fields: [submissionId], references: [id], onDelete: Cascade)

  message String
  rating  Int

  @@map("feedbacks")
}

model Report {
  submissionId String     @id @default(cuid()) @map("submission_id")
  submission   Submission @relation("submission-report", fields: [submissionId], references: [id], onDelete: Cascade)

  message String
  files   File[]

  @@map("reports")
}

model Contact {
  submissionId String     @id @default(cuid()) @map("submission_id")
  submission   Submission @relation("submission-contact", fields: [submissionId], references: [id], onDelete: Cascade)

  subject String?
  message String

  @@map("contacts")
}

model Survey {
  submissionId String     @id @default(cuid()) @map("submission_id")
  submission   Submission @relation("submission-survey", fields: [submissionId], references: [id], onDelete: Cascade)

  satisfaction Int
  options      String[]

  @@map("surveys")
}
